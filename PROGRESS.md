# ARM64 Hypervisor - é¡¹ç›®è¿›åº¦

## é¡¹ç›®æ¦‚è§ˆ

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªä»é›¶å¼€å§‹æ„å»ºçš„ ARM64 Type-1 Hypervisorï¼Œä½¿ç”¨ Rust å’Œå°‘é‡æ±‡ç¼–å®ç°ã€‚ç›®æ ‡æ˜¯åˆ›å»ºä¸€ä¸ªæ•™è‚²æ€§çš„ã€å¯ç†è§£çš„è™šæ‹ŸåŒ–å®ç°ã€‚

### ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Host (EL2)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚    VM        â”‚  â”‚   Device     â”‚  â”‚   Memory     â”‚ â”‚
â”‚  â”‚  Management  â”‚  â”‚  Emulation   â”‚  â”‚  Management  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                  â”‚                  â”‚         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚         Exception Handler & Trap Handling         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†• ERET/Exception
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Guest (EL1)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          Guest Operating System / Code           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Stage-2 Translation (GPA â†’ HPA)                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  Physical Memory  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆ

- **è¯­è¨€**: Rust (no_std) + ARM64 æ±‡ç¼–
- **ç›®æ ‡**: ARM64 (AArch64)
- **è¿è¡Œç¯å¢ƒ**: QEMU virt machine (å¼€å‘), è£¸æœº (æœªæ¥)
- **å·¥å…·é“¾**: rustc + aarch64-linux-gnu-*

### ä»£ç ç»Ÿè®¡ (æˆªè‡³ 2026-01-26)

- Rust ä»£ç : ~4100 è¡Œï¼ˆ+600ï¼‰
- æ±‡ç¼–ä»£ç : ~350 è¡Œï¼ˆ+50ï¼‰
- æ€»è®¡: ~4450 è¡Œ
- æµ‹è¯•ä»£ç : ~770 è¡Œï¼ˆ+370ï¼‰
- æ–‡æ¡£: ~1200 è¡Œ

## å·²å®Œæˆçš„ Sprint

### Sprint 1.1: vCPU Framework âœ…
**ç›®æ ‡**: å»ºç«‹åŸºæœ¬çš„ vCPU æŠ½è±¡å’Œ VM å…¥å£/å‡ºå£æœºåˆ¶

**å®Œæˆå†…å®¹**:
- âœ… VcpuContext æ•°æ®ç»“æ„ï¼ˆé€šç”¨å¯„å­˜å™¨ + ç³»ç»Ÿå¯„å­˜å™¨ï¼‰
- âœ… å¼‚å¸¸å‘é‡è¡¨ (EL2)
- âœ… VM å…¥å£/å‡ºå£æœºåˆ¶ (enter_guest, exception_handler)
- âœ… åŸºç¡€ hypercall æ¥å£
- âœ… ç®€å• guest ç¨‹åºæµ‹è¯•

**å…³é”®æ–‡ä»¶**:
- `src/vcpu.rs` - vCPU æŠ½è±¡
- `src/vm.rs` - VM ç®¡ç†
- `src/arch/aarch64/regs.rs` - å¯„å­˜å™¨å®šä¹‰
- `arch/aarch64/exception.S` - å¼‚å¸¸å‘é‡å’Œä¸Šä¸‹æ–‡åˆ‡æ¢
- `src/arch/aarch64/exception.rs` - å¼‚å¸¸å¤„ç†é€»è¾‘

### Sprint 1.2: Memory Management âœ…
**ç›®æ ‡**: å®ç° Stage-2 åœ°å€è½¬æ¢

**å®Œæˆå†…å®¹**:
- âœ… Stage-2 é¡µè¡¨ç»“æ„ (L1, L2, L3)
- âœ… Identity mapping (GPA == HPA)
- âœ… 2MB å—æ˜ å°„
- âœ… Memory attributes (NORMAL, DEVICE, READONLY)
- âœ… VTTBR_EL2 å’Œ VTCR_EL2 é…ç½®
- âœ… HCR_EL2.VM å¯ç”¨

**å…³é”®æ–‡ä»¶**:
- `src/arch/aarch64/mmu.rs` - MMU å’Œ Stage-2 å®ç°

**æŠ€æœ¯ç»†èŠ‚**:
- 40-bit IPA space (T0SZ = 24)
- 48-bit PA space  
- 4KB granule, start at Level 1
- Inner/Outer write-back cacheable

### Sprint 1.3: Interrupt Handling âœ…
**ç›®æ ‡**: å®ç°ä¸­æ–­è·¯ç”±å’Œå¤„ç†

**å®Œæˆå†…å®¹**:
- âœ… GIC (Generic Interrupt Controller) åŸºç¡€æ”¯æŒ
  - GICv2 å¯„å­˜å™¨å®šä¹‰
  - ç³»ç»Ÿå¯„å­˜å™¨æ¥å£é…ç½®
- âœ… ARM Generic Timer æ”¯æŒ
  - Virtual Timer (CNTV_*) å¯„å­˜å™¨è®¿é—®
  - å®šæ—¶å™¨é…ç½®å’ŒçŠ¶æ€æŸ¥è¯¢
- âœ… ä¸­æ–­å¤„ç†æ¡†æ¶
  - HCR_EL2 é…ç½® (IMO/FMO ä½)
  - IRQ/FIQ å¼‚å¸¸å¤„ç†
  - ä¸­æ–­ç¡®è®¤å’Œ EOI æœºåˆ¶
- âœ… å®šæ—¶å™¨ä¸­æ–­æµ‹è¯•
  - 100ms å®šæ—¶å™¨é…ç½®
  - ä¸­æ–­ pending çŠ¶æ€æ£€æµ‹

**å…³é”®æ–‡ä»¶**:
- `src/arch/aarch64/gic.rs` - GIC æ¥å£
- `src/arch/aarch64/timer.rs` - Timer æ”¯æŒ
- `tests/test_timer.rs` - å®šæ—¶å™¨æµ‹è¯•

**æµ‹è¯•ç»“æœ**:
- âœ… å®šæ—¶å™¨æˆåŠŸé…ç½® (62.5MHz)
- âœ… CNTV_CTL çŠ¶æ€æ­£ç¡®: 0x1 â†’ 0x5 (pending bit set)

### Sprint 1.4: Device Emulation âœ…
**ç›®æ ‡**: å®ç° MMIO è®¾å¤‡ä»¿çœŸæ¡†æ¶

**å®Œæˆå†…å®¹**:
- âœ… æŒ‡ä»¤è§£ç å™¨
  - Load/Store æŒ‡ä»¤è§£æ
  - ISS (Instruction Specific Syndrome) æ”¯æŒ
  - æ‰‹åŠ¨è§£ç ä½œä¸ºåå¤‡
- âœ… MMIO Trap-and-Emulate Handler
  - Data Abort å¤„ç†
  - æŒ‡ä»¤è§£ç å’Œä»¿çœŸ
  - Load: è®¾å¤‡è¯»å– â†’ guest å¯„å­˜å™¨
  - Store: guest å¯„å­˜å™¨ â†’ è®¾å¤‡å†™å…¥
- âœ… è®¾å¤‡ä»¿çœŸæ¡†æ¶
  - MmioDevice trait
  - DeviceManager è·¯ç”±
  - å…¨å±€è®¿é—®æ¥å£
- âœ… è™šæ‹Ÿ UART (PL011)
  - UARTDR, UARTFR, UARTCR å¯„å­˜å™¨
  - å­—ç¬¦è¾“å‡ºåˆ°çœŸå® UART
- âœ… è™šæ‹Ÿ GICD
  - GICD_CTLR, GICD_TYPER
  - GICD_ISENABLER/ICENABLER
  - é…ç½®å˜åŒ–æ—¥å¿—
- âœ… å¯„å­˜å™¨è®¿é—®æ¥å£
  - GeneralPurposeRegs::get_reg/set_reg
  - x0-x30 å®Œæ•´æ”¯æŒ

**å…³é”®æ–‡ä»¶**:
- `src/arch/aarch64/decode.rs` - æŒ‡ä»¤è§£ç 
- `src/devices/mod.rs` - è®¾å¤‡æ¡†æ¶
- `src/devices/uart.rs` - UART ä»¿çœŸ
- `src/devices/gicd.rs` - GICD ä»¿çœŸ
- `src/global.rs` - å…¨å±€çŠ¶æ€ç®¡ç†

**æ¶æ„ç‰¹ç‚¹**:
- Trap-and-emulate æ¨¡å¼
- è®¾å¤‡åœ°å€è·¯ç”±
- å¯æ‰©å±•è®¾å¤‡æ¡†æ¶
- Zero-copy ä»¿çœŸ

**å¾…å®Œæˆ**:
- Guest æµ‹è¯•ä»£ç æŒ‡ä»¤ç¼–ç ä¿®å¤ (æŠ€æœ¯å€ºåŠ¡)
- æ›´å¤šè®¾å¤‡æ”¯æŒ

### ç›®å½•ç»“æ„é‡ç»„ âœ…
**ç›®æ ‡**: å‚è€ƒ Hafnium é¡¹ç›®ä¼˜åŒ–ç›®å½•ç»“æ„

**Phase 1 å®Œæˆ**:
- âœ… æµ‹è¯•ä»£ç åˆ†ç¦»åˆ° `tests/` ç›®å½•
- âœ… åˆ›å»º `tests/mod.rs` ç»Ÿä¸€ç®¡ç†
- âœ… æ›´æ–°æ¨¡å—å¯¼å…¥è·¯å¾„

**å½“å‰ç»“æ„**:
```
hypervisor/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ vm.rs
â”‚   â”‚   â””â”€â”€ vcpu.rs
â”‚   â”œâ”€â”€ arch/
â”‚   â”‚   â””â”€â”€ aarch64/
â”‚   â”‚       â”œâ”€â”€ regs.rs
â”‚   â”‚       â”œâ”€â”€ exception.rs
â”‚   â”‚       â”œâ”€â”€ mmu.rs
â”‚   â”‚       â”œâ”€â”€ gic.rs
â”‚   â”‚       â”œâ”€â”€ timer.rs
â”‚   â”‚       â””â”€â”€ decode.rs
â”‚   â”œâ”€â”€ devices/
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ uart.rs
â”‚   â”‚   â””â”€â”€ gicd.rs
â”‚   â”œâ”€â”€ global.rs
â”‚   â”œâ”€â”€ lib.rs
â”‚   â””â”€â”€ main.rs
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ test_guest.rs
â”‚   â”œâ”€â”€ test_timer.rs
â”‚   â””â”€â”€ test_mmio.rs
â”œâ”€â”€ arch/
â”‚   â””â”€â”€ aarch64/
â”‚       â”œâ”€â”€ boot.S
â”‚       â””â”€â”€ exception.S
â””â”€â”€ Cargo.toml
```

**ä¸‹ä¸€æ­¥è®¡åˆ’**:
- Phase 2: è®¾å¤‡ä»£ç æŒ‰é©±åŠ¨åˆ†å­ç›®å½•
- Phase 3: æ¶æ„ä»£ç åˆ†å±‚ (hypervisor/, mm/, peripherals/)
- Phase 4: åˆ›å»º docs/ ç›®å½•

## æŠ€æœ¯äº®ç‚¹

### 1. å¼‚å¸¸å¤„ç†æµç¨‹
```
Guest execution (EL1)
  â†“ (Exception)
Exception Vector (EL2)
  â†“
Save Context
  â†“
Rust Handler (handle_exception)
  â†“
Route by exception type
  â†“
Handle (Hypercall/MMIO/IRQ)
  â†“
Return bool (continue/exit)
  â†“
Restore Context & ERET (if continue)
OR
Return to host (if exit)
```

### 2. MMIO ä»¿çœŸæµç¨‹
```
Guest: STR w1, [x19]  (è®¿é—® 0x09000000)
  â†“
Data Abort (FAR_EL2 = 0x09000000)
  â†“
è¯»å– faulting instruction (PC)
  â†“
è§£ç  (decode::MmioAccess)
  â†“
æå–: reg=19, size=4, is_store=true
  â†“
ä» x19 è¯»å–å€¼
  â†“
DeviceManager::handle_mmio(addr, value, size, true)
  â†“
UART::write(offset, value, size)
  â†“
è¾“å‡ºå­—ç¬¦åˆ°çœŸå® UART
  â†“
PC += 4, ERET back to guest
```

### 3. Stage-2 Translation
```
Guest VA (EL1) â†’ Guest PA (IPA)  [ç”± guest OS ç®¡ç†]
       â†“
IPA â†’ Host PA (HPA)              [ç”± hypervisor Stage-2 ç®¡ç†]
```

## æ€§èƒ½æŒ‡æ ‡

- **Context Switch**: ~æ•°ç™¾çº³ç§’ (å–å†³äºç¼“å­˜çŠ¶æ€)
- **Hypercall Overhead**: ~10-20æ¡æŒ‡ä»¤
- **MMIO Emulation**: ~100-200æ¡æŒ‡ä»¤

## ä»£ç ç»Ÿè®¡

```
Language      Files    Lines    Code
-----------------------------------
Rust             16    ~3500    ~2800
Assembly          2     ~300     ~250
Markdown          2     ~500     ~400
-----------------------------------
Total            20    ~4300    ~3450
```

## æµ‹è¯•è¦†ç›–

- âœ… Guest æ‰§è¡Œ (hypercall)
- âœ… å®šæ—¶å™¨ä¸­æ–­
- âš ï¸ MMIO ä»¿çœŸ (guest ä»£ç æœ‰æŒ‡ä»¤ç¼–ç é—®é¢˜)
- âœ… å†…å­˜æ˜ å°„
- âœ… å¼‚å¸¸å¤„ç†

## å·²çŸ¥é—®é¢˜

1. ~~**MMIO æµ‹è¯• guest ä»£ç **: ARM64 æŒ‡ä»¤ç¼–ç é—®é¢˜å¯¼è‡´ Instruction Abort~~  âœ… **å·²ä¿®å¤**
   - ~~å½±å“: æµ‹è¯•å¤±è´¥ï¼Œä½†æ¡†æ¶æœ¬èº«å®Œæ•´~~
   - ~~è§£å†³æ–¹æ¡ˆ: ä½¿ç”¨å¤–éƒ¨æ±‡ç¼–å™¨ç”Ÿæˆæ­£ç¡®æŒ‡ä»¤~~
   - **ä¿®å¤æ—¥æœŸ**: 2026-01-26
   - **æ ¹å› **: ExitReason æ˜ å°„é”™è¯¯ + MMIO è®¾å¤‡åŒºåŸŸæœªæ˜ å°„
   - **çŠ¶æ€**: âœ… å®Œå…¨ä¿®å¤ï¼ŒMMIO æµ‹è¯• 100% é€šè¿‡

2. **å•æ ¸é™åˆ¶**: ç›®å‰åªæ”¯æŒå•ä¸ª vCPU
   - å½±å“: æ— æ³•æµ‹è¯•å¤šæ ¸åœºæ™¯
   - è§£å†³æ–¹æ¡ˆ: å®ç° vCPU è°ƒåº¦å™¨
   - ä¼˜å…ˆçº§: ä½

3. **å†…å­˜åˆ†é…**: ä½¿ç”¨é™æ€å†…å­˜ï¼Œæ— åŠ¨æ€åˆ†é…å™¨
   - å½±å“: å†…å­˜ä½¿ç”¨ä¸çµæ´»
   - è§£å†³æ–¹æ¡ˆ: å®ç°ç®€å•çš„ bump allocator
   - ä¼˜å…ˆçº§: ä¸­

## ä¸‹ä¸€æ­¥è®¡åˆ’

### ç›®å½•ç»“æ„é‡ç»„ (2026-01-26 å®Œæˆ)

åŸºäº [Hafnium](https://github.com/TF-Hafnium/hafnium) é¡¹ç›®çš„æœ€ä½³å®è·µï¼Œæˆ‘ä»¬å¯¹ä»£ç åº“è¿›è¡Œäº†ç³»ç»Ÿæ€§é‡ç»„ï¼š

#### Phase 1: æµ‹è¯•åˆ†ç¦» âœ…
**å˜æ›´**:
```
src/test_*.rs  â†’  tests/test_*.rs
src/mod.rs     â†’  tests/mod.rs (æ–°å»º)
```

**æ”¶ç›Š**:
- æ¸…æ™°åŒºåˆ†äº§å“ä»£ç å’Œæµ‹è¯•ä»£ç 
- æ›´å¥½çš„æ¨¡å—åŒ–
- ç¬¦åˆ Rust é¡¹ç›®æƒ¯ä¾‹

#### Phase 2: è®¾å¤‡é©±åŠ¨æ¨¡å—åŒ– âœ…
**å˜æ›´**:
```
src/devices/
â”œâ”€â”€ mod.rs
â”œâ”€â”€ pl011/           (æ–°)
â”‚   â”œâ”€â”€ mod.rs
â”‚   â””â”€â”€ emulator.rs  (åŸ uart.rs)
â””â”€â”€ gic/             (æ–°)
    â”œâ”€â”€ mod.rs
    â””â”€â”€ distributor.rs  (åŸ gicd.rs)
```

**æ”¶ç›Š**:
- æ¯ä¸ªè®¾å¤‡ç‹¬ç«‹å­ç›®å½•
- ä¾¿äºæ·»åŠ æ›´å¤šè®¾å¤‡å®ç°ï¼ˆå¦‚ CPU interface, redistributorï¼‰
- éµå¾ª "ä¸€ä¸ªè®¾å¤‡ä¸€ä¸ªç›®å½•" åŸåˆ™

#### Phase 3: æ¶æ„ä»£ç åˆ†å±‚ âœ…
**å˜æ›´**:
```
src/arch/aarch64/
â”œâ”€â”€ regs.rs          (ä¿ç•™)
â”œâ”€â”€ hypervisor/      (æ–°)
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ exception.rs (EL2 å¼‚å¸¸å¤„ç†)
â”‚   â””â”€â”€ decode.rs    (æŒ‡ä»¤è§£ç )
â”œâ”€â”€ mm/              (æ–°)
â”‚   â”œâ”€â”€ mod.rs
â”‚   â””â”€â”€ mmu.rs       (å†…å­˜ç®¡ç†)
â””â”€â”€ peripherals/     (æ–°)
    â”œâ”€â”€ mod.rs
    â”œâ”€â”€ gic.rs       (GIC å¯„å­˜å™¨)
    â””â”€â”€ timer.rs     (ARM Timer)
```

**æ”¶ç›Š**:
- æ¸…æ™°çš„å±‚æ¬¡ç»“æ„ï¼šhypervisor (EL2) / mm (å†…å­˜) / peripherals (å¤–è®¾)
- æ›´å®¹æ˜“å®šä½ä»£ç 
- å‚è€ƒäº† Hafnium çš„ `src/arch/aarch64/hypervisor/` æ¨¡å¼

#### Phase 4: æ–‡æ¡£å®Œå–„ ğŸ”„
**è®¡åˆ’å†…å®¹**:
- âœ… æ›´æ–° PROGRESS.md
- æ·»åŠ æ¶æ„å›¾
- æ·»åŠ  API æ–‡æ¡£
- åˆ›å»ºå¼€å‘è€…æŒ‡å—

### æœ€ç»ˆç›®å½•ç»“æ„

```
hypervisor/
â”œâ”€â”€ arch/aarch64/        # æ±‡ç¼–å¯åŠ¨ä»£ç 
â”‚   â”œâ”€â”€ boot.S
â”‚   â””â”€â”€ exception.S
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ arch/aarch64/    # ARM64 ç‰¹å®šä»£ç 
â”‚   â”‚   â”œâ”€â”€ regs.rs
â”‚   â”‚   â”œâ”€â”€ hypervisor/  # EL2 ç‰¹å®š
â”‚   â”‚   â”œâ”€â”€ mm/          # å†…å­˜ç®¡ç†
â”‚   â”‚   â””â”€â”€ peripherals/ # å¤–è®¾é©±åŠ¨
â”‚   â”œâ”€â”€ devices/         # è®¾å¤‡æ¨¡æ‹Ÿ
â”‚   â”‚   â”œâ”€â”€ pl011/       # UART
â”‚   â”‚   â””â”€â”€ gic/         # ä¸­æ–­æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ vcpu.rs
â”‚   â”œâ”€â”€ vm.rs
â”‚   â”œâ”€â”€ global.rs
â”‚   â””â”€â”€ lib.rs
â”œâ”€â”€ tests/               # æµ‹è¯•ä»£ç 
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ test_guest.rs
â”‚   â”œâ”€â”€ test_timer.rs
â”‚   â””â”€â”€ test_mmio.rs
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ Makefile
â””â”€â”€ PROGRESS.md
```

## Sprint å€™é€‰è®¡åˆ’

### âœ… Sprint 1.5a: MMIO Testing & Code Quality (å®Œæˆäº 2026-01-26)
1. âœ… ä¿®å¤ MMIO æµ‹è¯•
2. âœ… æ¸…ç†ç¼–è¯‘è­¦å‘Š
3. âœ… ä»£ç è´¨é‡æå‡

### âœ… Sprint 1.5b: Guest Interrupt Injection (å®Œæˆäº 2026-01-26)
**ç›®æ ‡**: å®ç°ä» hypervisor å‘ guest æ³¨å…¥è™šæ‹Ÿä¸­æ–­

**å®Œæˆå†…å®¹**:
1. âœ… è™šæ‹Ÿä¸­æ–­çŠ¶æ€ç®¡ç†æ¨¡å— (vcpu_interrupt.rs)
   - VirtualInterruptState ç»“æ„
   - inject_irq/clear_irq API
   - HCR_EL2.VI/VF ä½æ§åˆ¶
2. âœ… é›†æˆåˆ° Vcpu ç»“æ„
   - virt_irq å­—æ®µ
   - run() æ–¹æ³•è‡ªåŠ¨åº”ç”¨ VI çŠ¶æ€
3. âœ… Guest ä¸­æ–­æµ‹è¯•
   - Guest unmask IRQ
   - Hypervisor æ³¨å…¥ IRQ 27
   - éªŒè¯ HCR_EL2.VI æœºåˆ¶

**å…³é”®æ–‡ä»¶**:
- `src/vcpu_interrupt.rs` - è™šæ‹Ÿä¸­æ–­ç®¡ç†
- `src/vcpu.rs` - é›†æˆä¸­æ–­æ³¨å…¥ API
- `tests/test_guest_interrupt.rs` - ä¸­æ–­æ³¨å…¥æµ‹è¯•

**æµ‹è¯•ç»“æœ**:
- âœ… Hypervisor æˆåŠŸæ³¨å…¥è™šæ‹Ÿ IRQ
- âœ… Guest åœ¨ unmask IRQ åç«‹å³æ”¶åˆ°ä¸­æ–­
- âœ… HCR_EL2.VI æœºåˆ¶éªŒè¯å·¥ä½œ
- âš ï¸ Guest éœ€å®Œæ•´å¼‚å¸¸å‘é‡è¡¨ (åç»­ä¼˜åŒ–)

**å·¥ä½œæ—¶é•¿**: ~4å°æ—¶

### âœ… Sprint 1.6: Complete Interrupt Injection (å®Œæˆäº 2026-01-26)
**ç›®æ ‡**: å®Œå–„ä¸­æ–­æ³¨å…¥åŠŸèƒ½ï¼Œå®ç°å®Œæ•´çš„ Guest å¼‚å¸¸å¤„ç†æµç¨‹

**å®Œæˆå†…å®¹**:
1. âœ… **Guest å¼‚å¸¸å‘é‡è¡¨** - å®Œæ•´çš„ EL1 å¼‚å¸¸å‘é‡è¡¨ï¼ˆ2KBï¼Œ16ä¸ªå‘é‡å…¥å£ï¼‰
2. âœ… **IRQ Handler å®ç°** - Guest ç«¯ä¸­æ–­å¤„ç†ç¨‹åºï¼ˆä¿å­˜/æ¢å¤ä¸Šä¸‹æ–‡ï¼ŒEOIï¼‰
3. âœ… **WFI æ”¯æŒ** - æ­£ç¡®å¤„ç† Wait-For-Interrupt æŒ‡ä»¤
   - Hypervisor æ£€æµ‹ WFIï¼ˆEC = 0x01ï¼‰
   - è¿”å›ç‰¹æ®Šé€€å‡ºç ï¼ˆ1ï¼‰
   - PC += 4 è·³è¿‡ WFI æŒ‡ä»¤
4. âœ… **å¤šæ¬¡ä¸­æ–­æ³¨å…¥** - æ”¯æŒè¿ç»­æ³¨å…¥å¤šä¸ªè™šæ‹Ÿä¸­æ–­ï¼ˆæµ‹è¯• 3 æ¬¡ï¼‰
5. âœ… **è‡ªåŠ¨ EOI** - Guest è¿”å›åè‡ªåŠ¨æ¸…é™¤ VI ä½

**å…³é”®å®ç°**:
- **Vector Table**: 0x280 åç§»çš„ IRQ handlerï¼ˆCurrent EL with SPxï¼‰
- **Context Save/Restore**: ä¿å­˜ x0, x1, x29, x30ï¼Œé€’å¢è®¡æ•°å™¨ï¼ŒERET è¿”å›
- **WFI Detection**: æ±‡ç¼–å±‚é¢æ£€æµ‹ ESR_EL2.ECï¼Œè¿”å›ä¸åŒé€€å‡ºç 
- **Test Loop**: WFI â†’ Inject â†’ Handle â†’ Resumeï¼ˆå¾ªç¯ 3 æ¬¡ï¼‰

**æŠ€æœ¯äº®ç‚¹**:
- å®Œæ•´çš„ç«¯åˆ°ç«¯ä¸­æ–­æµç¨‹
- Guest å¼‚å¸¸å‘é‡è¡¨ç¬¦åˆ ARM64 è§„èŒƒï¼ˆ2KBå¯¹é½ï¼Œ128å­—èŠ‚/å‘é‡ï¼‰
- è‡ªåŠ¨åŒ–æµ‹è¯•ï¼šéªŒè¯ 3 æ¬¡ä¸­æ–­éƒ½è¢«æ­£ç¡®å¤„ç†

**æµ‹è¯•ç»“æœ**:
- âœ… Guest è®¾ç½® VBAR_EL1 æˆåŠŸ
- âœ… Guest unmask IRQ (DAIF.I = 0)
- âœ… 3 æ¬¡ WFI å¾ªç¯æˆåŠŸ
- âœ… ä¸­æ–­è®¡æ•°å™¨æ­£ç¡®é€’å¢åˆ° 3
- âœ… Guest é€šè¿‡ x0 è¿”å›æ­£ç¡®çš„è®¡æ•°å€¼

**å·¥ä½œæ—¶é•¿**: ~2å°æ—¶

**æ–‡æ¡£**: è¯¦è§ `docs/SPRINT_1.6_SUMMARY.md`

---

### Sprint 1.6+ å€™é€‰:
1. **GIC CPU Interface**: å®Œæ•´ GICv2 æ”¯æŒ (3-4h) â­ æ¨è
2. **API æ–‡æ¡£**: Rustdoc æ³¨é‡Šå’Œæ–‡æ¡£ç”Ÿæˆ (1-2h)
3. **åŠ¨æ€å†…å­˜ç®¡ç†**: å®ç° Bump allocator (4-6h)
4. **å¤š vCPU æ”¯æŒ**: vCPU è°ƒåº¦ (15-20h)
4. **PSCI**: ç”µæºç®¡ç†æ¥å£ (8-10h)

### æ¶æ„ä¼˜åŒ–:
1. âœ… Phase 1: æµ‹è¯•ä»£ç åˆ†ç¦» (å®Œæˆäº 2026-01-26)
2. âœ… Phase 2: è®¾å¤‡é©±åŠ¨å­ç›®å½•åŒ– (å®Œæˆäº 2026-01-26)
3. âœ… Phase 3: æ¶æ„ä»£ç åˆ†å±‚ (å®Œæˆäº 2026-01-26)
4. âœ… Phase 4: æ–‡æ¡£å®Œå–„ (å®Œæˆäº 2026-01-26)

### ä»£ç è´¨é‡æå‡ (2026-01-26 å®Œæˆ):
1. âœ… ä¿®å¤ MMIO æµ‹è¯• - Sprint 1.4 100% å®Œæˆ
   - ä¿®å¤ ExitReason EC æ˜ å°„é”™è¯¯ (0x24/0x25 = Data Abort)
   - æ·»åŠ  MMIO è®¾å¤‡åŒºåŸŸ Stage-2 æ˜ å°„
   - Guest æˆåŠŸé€šè¿‡ MMIO è®¿é—®è™šæ‹Ÿ UART

2. âœ… æ¸…ç†ç¼–è¯‘è­¦å‘Š - ä» 20+ é™è‡³ ~8 ä¸ª
   - æœªä½¿ç”¨å˜é‡/å¸¸é‡/å­—æ®µå¤„ç†
   - æ¨¡ç³Šå¯¼å‡ºæ”¹ä¸ºæ˜¾å¼å¯¼å‡º
   - static mut æ”¹ä¸º &raw const

### æµ‹è¯•è¦†ç›– (æ›´æ–° 2026-01-26):
- âœ… Guest æ‰§è¡Œ (hypercall) - 100% é€šè¿‡
- âœ… å®šæ—¶å™¨ä¸­æ–­ - 100% é€šè¿‡
- âœ… MMIO ä»¿çœŸ - 100% é€šè¿‡
- âœ… å†…å­˜æ˜ å°„ - 100% é€šè¿‡
- âœ… å¼‚å¸¸å¤„ç† - 100% é€šè¿‡
- âœ… **è™šæ‹Ÿä¸­æ–­æ³¨å…¥ - åŸºç¡€åŠŸèƒ½é€šè¿‡** â† æ–°å¢

**è¦†ç›–ç‡**: 6/6 æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•é€šè¿‡

## å‚è€ƒèµ„æ–™

- **ARM Architecture**: ARM ARM (ARMv8-A)
- **Hafnium**: TF-Hafnium/hafnium (å‚è€ƒé¡¹ç›®)
- **KVM/ARM**: Linux KVM ARM å®ç°
- **Rust Embedded**: embedded-rs ç”Ÿæ€

## å›¢é˜Ÿ

- ä¸»è¦å¼€å‘: [ä½ çš„åå­—]
- AI è¾…åŠ©: Claude (Anthropic)

## è®¸å¯è¯

[å¾…å®š]

---

æœ€åæ›´æ–°: 2026-01-26

### ğŸ¯ Sprint 1.6 å€™é€‰ (ä¸‹ä¸€æ­¥):

#### **é€‰é¡¹ A: å®Œå–„ä¸­æ–­æ³¨å…¥** [2-3h]
1. Guest å®Œæ•´å¼‚å¸¸å‘é‡è¡¨è®¾ç½®
2. EOI (End of Interrupt) å¤„ç†
3. å¤šæ¬¡ä¸­æ–­æ³¨å…¥æµ‹è¯•

#### **é€‰é¡¹ B: åŠ¨æ€å†…å­˜ç®¡ç†** [4-6h]
1. å®ç° Bump allocator
2. åŠ¨æ€é¡µè¡¨åˆ†é…
3. è®¾å¤‡çŠ¶æ€åŠ¨æ€åˆ†é…

#### **é€‰é¡¹ C: GIC CPU Interface** [3-4h]
1. å®ç° GICC (0x08010000)
2. GICC_CTLR, GICC_PMR, GICC_IAR, GICC_EOIR
3. å®Œæ•´ GICv2 æ”¯æŒ

#### **é€‰é¡¹ D: API æ–‡æ¡£** [1-2h]
1. Rustdoc æ³¨é‡Š
2. CONTRIBUTING.md
3. è®¾å¤‡æ‰©å±•æŒ‡å—

---

**æœ€åæ›´æ–°**: 2026-01-26 (Sprint 1.6 å®Œæˆ - å®Œå–„ä¸­æ–­æ³¨å…¥)
